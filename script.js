
// Momento Store - final script
const CART_KEY = 'momento_store_cart';
const REVIEWS_KEY = 'momento_store_reviews';
let PRODUCTS = [];

fetch('products.json').then(r=>r.json()).then(j=>{ PRODUCTS=j; initApp(); }).catch(e=>{ console.error(e); PRODUCTS=[]; initApp(); });

function el(html){ const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstChild; }
function toast(msg, t=2000){ const wrap=document.getElementById('toasts'); if(!wrap) return; const e=document.createElement('div'); e.className='toast'; e.textContent=msg; wrap.appendChild(e); setTimeout(()=>{ e.style.opacity=0; setTimeout(()=>e.remove(),400); }, t); }
function formatEGP(n){ return n + ' ج.م'; }

function initApp(){ renderProducts(PRODUCTS); renderCart(); updateCartCount(); attachEvents(); renderProductPageIfNeeded(); }

function renderProducts(list){ const container=document.getElementById('productsArea'); if(!container) return; container.innerHTML=''; list.forEach(p=>{ const img = p.images && p.images[0] ? p.images[0] : ''; const card = el('<div class="card" data-id="'+p.id+'"><img loading="lazy" src="'+img+'"><h3>'+p.en+'</h3><div style="color:var(--muted)">'+(p.desc_en||'')+'</div><div style="display:flex;justify-content:space-between;align-items:center"><div class="price">'+p.price+' ج.م</div><div class="actions"><button class="btn ghost view" data-id="'+p.id+'">View</button><button class="btn small add" data-id="'+p.id+'">Add</button></div></div></div>'); container.appendChild(card); }); document.getElementById('resultsInfo') && (document.getElementById('resultsInfo').textContent = list.length + ' items'); attachCardEvents(); }

function attachCardEvents(){ document.querySelectorAll('.view').forEach(b=>b.addEventListener('click', e=>{ const id=Number(e.target.dataset.id); localStorage.setItem('selectedProductId', id); window.location.href='product.html'; })); document.querySelectorAll('.add').forEach(b=>b.addEventListener('click', e=> addToCart(Number(e.target.dataset.id)))); }

function getCart(){ return JSON.parse(localStorage.getItem(CART_KEY)||'[]'); }
function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); renderCart(); updateCartCount(); toast('Cart updated'); }
function addToCart(id, opts){ const cart=getCart(); const p=PRODUCTS.find(x=>x.id===id); if(!p) return; const size=(opts && opts.size) || (p.sizes && p.sizes[0]) || 'Free'; const color=(opts && opts.color) || (p.colors && p.colors[0]) || 'Default'; const ex=cart.find(i=>i.id===id && i.size===size && i.color===color); if(ex) ex.qty+=1; else cart.push({id,qty:1,size,color}); saveCart(cart); }

function renderCart(){ const c=document.getElementById('cartItems'); if(!c) return; const cart=getCart(); c.innerHTML=''; let total=0; cart.forEach(it=>{ const p=PRODUCTS.find(x=>x.id===it.id) || {}; const row = el('<div style="display:flex;justify-content:space-between;padding:8px 0"><div>'+ (p.en||'') + ' x' + it.qty +'</div><div>'+ (p.price||0)*it.qty +' ج.م</div></div>'); c.appendChild(row); total += (p.price||0)*it.qty; }); document.getElementById('cartTotal') && (document.getElementById('cartTotal').textContent = formatEGP(total)); renderCheckoutItems(); }
function updateCartCount(){ const el=document.getElementById('cartCount'); if(!el) return; const cnt=getCart().reduce((s,i)=>s+i.qty,0); el.textContent = cnt; }
function renderCheckoutItems(){ const elc=document.getElementById('checkoutItems'); if(!elc) return; const cart=getCart(); elc.innerHTML=''; let total=0; cart.forEach(it=>{ const p=PRODUCTS.find(x=>x.id===it.id) || {}; const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='8px 0'; row.innerHTML = '<div>'+p.en+' • '+it.size+' • '+it.color+' x'+it.qty+'</div><div>'+ (p.price||0)*it.qty +' ج.م</div>'; elc.appendChild(row); total += (p.price||0)*it.qty; }); const elTotal=document.getElementById('checkoutTotal'); if(elTotal) elTotal.textContent = formatEGP(total); }

function attachEvents(){ document.getElementById('openCart') && document.getElementById('openCart').addEventListener('click', ()=>{ document.getElementById('cartDrawer').classList.add('open'); }); document.body.addEventListener('click', function(e){ if(e.target.matches('.sidebar a[data-cat]')){ e.preventDefault(); const cat=e.target.getAttribute('data-cat'); const list = cat? PRODUCTS.filter(p=>p.cat===cat): PRODUCTS; renderProducts(list); } }); const s = document.getElementById('search'); s && s.addEventListener('input', e=>{ const q=e.target.value.trim().toLowerCase(); const filtered = PRODUCTS.filter(p=> (p.en && p.en.toLowerCase().includes(q)) || (p.ar && p.ar.toLowerCase().includes(q)) ); renderProducts(filtered); }); const sort = document.getElementById('sort'); sort && sort.addEventListener('change', ()=>{ const v=sort.value; let list=[...PRODUCTS]; if(v==='price-asc') list.sort((a,b)=>a.price-b.price); if(v==='price-desc') list.sort((a,b)=>b.price-a.price); renderProducts(list); }); const checkoutForm = document.getElementById('checkoutForm'); if(checkoutForm) checkoutForm.addEventListener('submit', function(e){ e.preventDefault(); const cart=getCart(); if(cart.length===0){ document.getElementById('orderMsg').textContent='Cart is empty'; return; } localStorage.removeItem(CART_KEY); saveCart([]); document.getElementById('orderMsg').textContent='Order placed. Thank you!'; setTimeout(()=>{ window.location.href='index.html'; },1200); }); }

function renderProductPageIfNeeded(){ if(!window.location.pathname.endsWith('product.html')) return; const sel = Number(window.__SELECTED_PROD || localStorage.getItem('selectedProductId') || 0); const id = sel || 0; const p = PRODUCTS.find(x=>x.id===id) || PRODUCTS[0]; if(!p) return; document.getElementById('prodTitle').textContent = p.en; document.getElementById('prodPrice').textContent = p.price + ' ج.م'; document.getElementById('prodDesc').textContent = p.desc_en || p.desc_ar || ''; const thumbs = document.getElementById('prodThumbs'); thumbs.innerHTML=''; (p.images||[]).forEach((u,idx)=>{ const img=document.createElement('img'); img.src=u; if(idx===0) img.classList.add('active'); img.addEventListener('click', ()=>{ document.getElementById('prodMainImg').src = u; thumbs.querySelectorAll('img').forEach(i=>i.classList.remove('active')); img.classList.add('active'); }); thumbs.appendChild(img); }); document.getElementById('prodMainImg').src = (p.images&&p.images[0])||''; const cs = document.getElementById('prodColor'); const ss = document.getElementById('prodSize'); cs.innerHTML=''; ss.innerHTML=''; (p.colors||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; cs.appendChild(o); }); (p.sizes||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; ss.appendChild(o); }); const all = JSON.parse(localStorage.getItem(REVIEWS_KEY)||'[]'); const revs = all.filter(r=>r.productId===p.id) || []; const rl = document.getElementById('reviewsList'); rl.innerHTML=''; revs.forEach(r=>{ const d=document.createElement('div'); d.className='review'; d.innerHTML = '<strong>'+ (r.name||'User') +'</strong> - <span>'+ r.rating + '★</span><p>'+ r.text +'</p>'; rl.appendChild(d); }); document.getElementById('submitReview').addEventListener('click', function(){ const name=document.getElementById('reviewName').value||'Anon'; const text=document.getElementById('reviewText').value||''; const rating=Number(document.getElementById('reviewRating').value||5); const all = JSON.parse(localStorage.getItem(REVIEWS_KEY)||'[]'); all.push({productId:p.id,name,text,rating,date:Date.now()}); localStorage.setItem(REVIEWS_KEY, JSON.stringify(all)); toast('Review added'); const d=document.createElement('div'); d.className='review'; d.innerHTML = '<strong>'+name+'</strong> - <span>'+rating+'★</span><p>'+text+'</p>'; document.getElementById('reviewsList').prepend(d); document.getElementById('reviewName').value=''; document.getElementById('reviewText').value=''; }); document.getElementById('addToCartBtn').addEventListener('click', function(){ const size=document.getElementById('prodSize').value; const color=document.getElementById('prodColor').value; addToCart(p.id,{size,color}); }); const related = PRODUCTS.filter(x=>x.cat===p.cat && x.id!==p.id).slice(0,6); const rg=document.getElementById('relatedGrid'); rg.innerHTML=''; related.forEach(rp=>{ const card = el('<div class="card"><img src="'+(rp.images&&rp.images[0]||'')+'"><h3>'+rp.en+'</h3><div class="price">'+rp.price+' ج.م</div><div style="margin-top:8px"><button class="btn ghost" onclick="(function(){ localStorage.setItem(\'selectedProductId\','+rp.id+'); window.location.href=\'product.html\'; })()">View</button></div></div>'); rg.appendChild(card); }); }

